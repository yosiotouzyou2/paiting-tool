<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebRTCæ¥ç¶šãƒ†ã‚¹ãƒˆ</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.9/minified/html5-qrcode.min.js" defer></script>
</head>
<body>
<h2>WebRTCæ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>

<button id="create-offer">ãƒ›ã‚¹ãƒˆ (QRç”Ÿæˆ)</button>
<button id="scan-offer">ã‚²ã‚¹ãƒˆ (QRèª­ã¿å–ã‚Š)</button>

<div id="qr-area"></div>
<div id="reader" style="width:300px;height:300px;margin:auto;"></div>
<textarea id="log" readonly style="width:90%;height:150px;"></textarea>

<script>
let pc, dataChannel, html5QrCode;

function log(msg){
  const box=document.getElementById("log");
  box.value+=msg+"\n";
  box.scrollTop=box.scrollHeight;
}

function initPeerConnection(){
  pc = new RTCPeerConnection();

  pc.onicecandidate = (e)=>{
    if(e.candidate===null) log("âœ… ICE gathering å®Œäº†");
  };

  pc.ondatachannel = (event)=>{
    dataChannel = event.channel;
    setupDataChannel();
  };
}

function setupDataChannel(){
  dataChannel.onopen = ()=>log("ğŸ”— DataChannel ã‚ªãƒ¼ãƒ—ãƒ³");
  dataChannel.onmessage = (e)=>log("ğŸ“¨ å—ä¿¡: "+e.data);
  dataChannel.onclose = ()=>log("âŒ DataChannel ã‚¯ãƒ­ãƒ¼ã‚º");
}

// Offerä½œæˆ
async function createOffer(){
  initPeerConnection();
  dataChannel = pc.createDataChannel("test");
  setupDataChannel();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  displayQr(JSON.stringify(pc.localDescription));
  log("ğŸ“¤ Offerã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
}

// QRè¡¨ç¤º
function displayQr(text){
  const area=document.getElementById("qr-area");
  area.innerHTML="";
  const canvasQR=document.createElement("canvas");
  area.appendChild(canvasQR);
  QRCode.toCanvas(canvasQR,text,{width:300});
  canvasQR.addEventListener("click", async ()=>{
    const answerText=prompt("ç›¸æ‰‹ã‹ã‚‰ã‚‚ã‚‰ã£ãŸQRãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã£ã¦ãã ã•ã„:");
    if(answerText) await applyAnswer(answerText);
  });
}

// QRèª­ã¿å–ã‚Š
async function scanOffer(){
  const readerDiv=document.getElementById("reader");
  readerDiv.style.display="block";
  html5QrCode = new Html5Qrcode("reader");
  await html5QrCode.start({facingMode:"environment"}, {}, async (text)=>{
    log("ğŸ“· QRèª­ã¿å–ã‚ŠæˆåŠŸ");
    await html5QrCode.stop();
    document.getElementById("reader").innerHTML="";
    const offer=JSON.parse(text);
    await createAnswer(offer);
  });
}

// Answerä½œæˆ
async function createAnswer(offer){
  initPeerConnection();
  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  displayQr(JSON.stringify(pc.localDescription));
  log("ğŸ“¤ Answerã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
}

// Answeré©ç”¨
async function applyAnswer(answerText){
  const answer=JSON.parse(answerText);
  await pc.setRemoteDescription(answer);
  log("âœ… æ¥ç¶šå®Œäº†ï¼");
}

document.getElementById("create-offer").addEventListener("click",createOffer);
document.getElementById("scan-offer").addEventListener("click",scanOffer);
</script>
</body>
</html>
